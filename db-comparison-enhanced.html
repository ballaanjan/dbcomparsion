<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Database Comparison Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .dropdown-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .dropdown-container h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1em;
        }
        
        .dropdown-container select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .content {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-right: 200px;
        }
        
        .content h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .demo-text {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .upload-buttons-container {
            display: block;
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .upload-buttons-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .upload-button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            margin: 10px 0;
            border: 2px dashed #007bff;
            border-radius: 8px;
            background: #f8f9fa;
            color: #007bff;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-button:hover {
            background: #e3f2fd;
            border-color: #0056b3;
        }
        
        .upload-button.uploaded {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .file-info {
            font-size: 14px;
            margin-top: 5px;
            color: #666;
        }
        
        .compare-button-container {
            text-align: center;
            margin-top: 30px;
        }
        
        .compare-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .compare-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0,0,0,0.3);
        }
        
        .compare-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }

        .results-container {
            margin-top: 30px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="dropdown-container">
        <h3>Select No of DB's for Comparison</h3>
        <select id="dbDropdown" onchange="showUploadButtons()">
            <option value="">-- Select --</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
        </select>
    </div>

    <div class="content">
        <h1>Enhanced Database Comparison Tool</h1>
        <p class="demo-text">Use the dropdown in the top-right corner to select the number of databases for comparison.</p>
        
        <div id="uploadButtonsContainer" class="upload-buttons-container">
            <h3>Upload Database Files (.csv)</h3>
            <div id="uploadButtons"></div>
            
            <div class="compare-button-container">
                <button id="compareButton" class="compare-button" onclick="compareFiles()" disabled>
                    Compare Databases
                </button>
                <div id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div id="progressText" style="text-align: center; margin-top: 5px;"></div>
                </div>
            </div>
        </div>

        <div id="resultsContainer" class="results-container" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Comparison Results</h3>
                <button onclick="downloadResults()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    üìÑ Download Report
                </button>
            </div>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        let uploadedFiles = {};
        let selectedDbCount = 0;
        
        function showUploadButtons() {
            const dropdown = document.getElementById('dbDropdown');
            const selectedValue = parseInt(dropdown.value);
            selectedDbCount = selectedValue;
            const container = document.getElementById('uploadButtons');
            
            if (selectedValue) {
                let buttonsHtml = '';
                for (let i = 0; i < selectedValue; i++) {
                    const dbName = i === 0 ? 'Source DB' : `Destination DB${i}`;
                    buttonsHtml += `
                        <div>
                            <input type="file" id="file${i}" accept=".csv" onchange="handleFileUpload(${i}, this)" style="display: none;">
                            <label for="file${i}" class="upload-button" id="label${i}">
                                üìÅ Upload ${dbName}
                            </label>
                            <div id="fileInfo${i}" class="file-info" style="display: none;"></div>
                        </div>
                    `;
                }
                container.innerHTML = buttonsHtml;
                checkCompareButtonState();
            }
        }
        
        function handleFileUpload(index, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvData = e.target.result;
                    uploadedFiles[`file${index}`] = {
                        name: file.name,
                        data: csvData,
                        size: file.size
                    };
                    
                    const label = document.getElementById(`label${index}`);
                    const fileInfo = document.getElementById(`fileInfo${index}`);
                    
                    label.textContent = `‚úÖ ${file.name}`;
                    label.classList.add('uploaded');
                    fileInfo.textContent = `File size: ${(file.size / 1024).toFixed(1)} KB`;
                    fileInfo.style.display = 'block';
                    
                    checkCompareButtonState();
                };
                reader.readAsText(file);
            }
        }
        
        function checkCompareButtonState() {
            const uploadedCount = Object.keys(uploadedFiles).length;
            const compareButton = document.getElementById('compareButton');
            compareButton.disabled = uploadedCount < selectedDbCount;
        }
        
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/['"]/g, ''));
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/['"]/g, ''));
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || null;
                    });
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        function performComparison() {
            const files = {};
            const parsedData = {};
            
            // Parse all uploaded files
            Object.keys(uploadedFiles).forEach(fileId => {
                const file = uploadedFiles[fileId];
                files[fileId] = file.name;
                parsedData[fileId] = parseCSV(file.data);
            });
            
            // Get all unique fields
            const allFields = new Set();
            Object.values(parsedData).forEach(data => {
                if (data.length > 0) {
                    Object.keys(data[0]).forEach(field => allFields.add(field));
                }
            });
            
            // Analyze each field
            const fieldComparison = Array.from(allFields).map(field => {
                const presence = {};
                const values = {};
                
                Object.keys(files).forEach(fileId => {
                    const data = parsedData[fileId];
                    if (data.length > 0 && data[0].hasOwnProperty(field)) {
                        presence[fileId] = 'Yes';
                        values[fileId] = data[0][field]; // Get first row value
                    } else {
                        presence[fileId] = 'No';
                        values[fileId] = null;
                    }
                });

                // Check if values match across all files (case-insensitive)
                const presentValues = Object.values(values).filter(v => v !== null && v !== undefined);
                let matchStatus = 'Not Matched';
                if (presentValues.length > 1) {
                    const normalizedValues = presentValues.map(v => v.toString().toLowerCase().trim());
                    const allSame = normalizedValues.every(val => val === normalizedValues[0]);
                    matchStatus = allSame ? 'Matched' : 'Not Matched';
                } else if (presentValues.length === 1) {
                    matchStatus = 'Single Value';
                }

                return {
                    field: field,
                    presence: presence,
                    values: values,
                    matchStatus: matchStatus
                };
            });
            
            // Generate summary
            const summary = {
                totalFiles: Object.keys(files).length,
                totalFields: allFields.size,
                recordCounts: {}
            };
            
            Object.keys(parsedData).forEach(fileId => {
                summary.recordCounts[fileId] = parsedData[fileId].length;
            });
            
            return {
                files: files,
                fieldComparison: fieldComparison,
                summary: summary,
                timestamp: new Date().toISOString()
            };
        }
        
        function compareFiles() {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');
            
            progressContainer.style.display = 'block';
            progressText.textContent = 'Processing files...';
            progressFill.style.width = '30%';
            
            setTimeout(() => {
                progressText.textContent = 'Analyzing data...';
                progressFill.style.width = '60%';
                
                setTimeout(() => {
                    const results = performComparison();
                    window.comparisonResults = results;
                    
                    progressText.textContent = 'Generating report...';
                    progressFill.style.width = '90%';
                    
                    setTimeout(() => {
                        displayResults(results);
                        progressFill.style.width = '100%';
                        progressText.textContent = 'Complete!';
                        
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            resultsContainer.style.display = 'block';
                        }, 500);
                    }, 300);
                }, 500);
            }, 300);
        }
        
        function displayResults(results) {
            const container = document.getElementById('resultsContent');
            
            const fieldsInAllFiles = results.fieldComparison.filter(f => Object.values(f.presence).every(p => p === 'Yes')).length;
            const matchedFields = results.fieldComparison.filter(f => f.matchStatus === 'Matched').length;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.9em; opacity: 0.9;">Total Fields</div>
                        <div style="font-size: 1.8em; font-weight: bold;">${results.summary.totalFields}</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.9em; color: #666;">In All Files</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #155724;">${fieldsInAllFiles}</div>
                    </div>
                    <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.9em; color: #666;">Matched Values</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #0c5460;">${matchedFields}</div>
                    </div>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Field Name</th>
            `;
            
            Object.keys(results.files).forEach(fileId => {
                html += `<th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">${results.files[fileId]}</th>`;
            });
            
            html += `
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Coverage</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Match Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.fieldComparison.forEach(field => {
                const presentCount = Object.values(field.presence).filter(p => p === 'Yes').length;
                const totalFiles = Object.keys(field.presence).length;
                const coverageColor = presentCount === totalFiles ? '#28a745' : 
                                     presentCount >= Math.ceil(totalFiles / 2) ? '#ffc107' : '#dc3545';
                
                const matchStatusColor = field.matchStatus === 'Matched' ? '#28a745' : 
                                        field.matchStatus === 'Not Matched' ? '#dc3545' : '#ffc107';
                
                html += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 10px; font-weight: bold;">${field.field}</td>
                `;
                
                Object.keys(results.files).forEach(fileId => {
                    const isPresent = field.presence[fileId] === 'Yes';
                    const value = field.values[fileId];
                    const displayValue = value !== null && value !== undefined ? value.toString() : '';
                    
                    html += `
                        <td style="padding: 10px; max-width: 200px;">
                            <div style="color: ${isPresent ? '#28a745' : '#dc3545'}; font-weight: bold; margin-bottom: 4px;">
                                ${isPresent ? '‚úÖ Yes' : '‚ùå No'}
                            </div>
                            ${isPresent ? `<div style="background: #f8f9fa; padding: 4px 6px; border-radius: 3px; font-family: monospace; font-size: 0.85em; word-break: break-word;"><code>${displayValue}</code></div>` : ''}
                        </td>
                    `;
                });
                
                html += `
                        <td style="padding: 10px; text-align: center; color: ${coverageColor}; font-weight: bold;">${presentCount}/${totalFiles}</td>
                        <td style="padding: 10px; text-align: center;">
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; 
                                         background: ${matchStatusColor === '#28a745' ? '#d4edda' : matchStatusColor === '#dc3545' ? '#f8d7da' : '#fff3cd'};
                                         color: ${matchStatusColor};">
                                ${field.matchStatus}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        
        function downloadResults() {
            if (!window.comparisonResults) return;
            
            const results = window.comparisonResults;
            const timestamp = new Date(results.timestamp).toLocaleString();
            const totalFiles = results.summary.totalFiles;
            const totalFields = results.summary.totalFields;
            const fieldsInAllFiles = results.fieldComparison.filter(f => Object.values(f.presence).every(p => p === 'Yes')).length;
            const matchedFields = results.fieldComparison.filter(f => f.matchStatus === 'Matched').length;
            const notMatchedFields = results.fieldComparison.filter(f => f.matchStatus === 'Not Matched').length;
            const qualityScore = totalFields > 0 ? Math.round((fieldsInAllFiles / totalFields) * 100) : 0;
            
            const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Comparison Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .timestamp {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
        }
        .summary-card h3 {
            color: #34495e;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .summary-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
        }
        .comparison-section {
            background: white;
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .comparison-header {
            color: white;
            padding: 20px 30px;
            font-size: 1.3em;
            font-weight: bold;
        }
        .comparison-content {
            padding: 30px;
        }
        .stat-item {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .stat-item .label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }
        .stat-item .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #495057;
        }
        .differences-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }
        .differences-table th,
        .differences-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        .differences-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .differences-table tr:hover {
            background: #f8f9fa;
        }
        .value-cell {
            max-width: 250px;
            padding: 8px 12px !important;
            vertical-align: top;
        }
        .presence-indicator {
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 0.9em;
        }
        .presence-indicator.present {
            color: #28a745;
        }
        .presence-indicator.missing {
            color: #dc3545;
        }
        .value-preview {
            font-size: 0.85em;
            background: #f8f9fa;
            padding: 6px 8px;
            border-radius: 4px;
            border-left: 3px solid #007acc;
            margin-top: 4px;
            word-break: break-word;
            line-height: 1.3;
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .match-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .match-status.matched {
            background: #d4edda;
            color: #155724;
        }
        .match-status.not-matched {
            background: #f8d7da;
            color: #721c24;
        }
        .match-status.single-value {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Database Comparison Report</h1>
            <div class="timestamp">Generated on: ${timestamp}</div>
        </div>

        <div class="summary-grid">
            ${Object.keys(results.files).map((fileId, index) => {
                const fileName = results.files[fileId].replace(/\.[^/.]+$/, "");
                const displayName = index === 0 ? 'Source DB' : `Destination ${index}`;
                return `
                <div class="summary-card">
                    <h3>${displayName}</h3>
                    <div class="number">${results.summary.recordCounts[fileId] || 0}</div>
                    <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 5px;">Records</div>
                </div>`;
            }).join('')}
            <div class="summary-card">
                <h3>Matched Fields</h3>
                <div class="number">${matchedFields}</div>
                <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 5px;">Perfect matches</div>
            </div>
            <div class="summary-card">
                <h3>Data Quality</h3>
                <div class="number">${qualityScore}%</div>
                <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 5px;">Coverage score</div>
            </div>
        </div>

        <div class="comparison-section" style="border: 2px solid #6f42c1;">
            <div class="comparison-header" style="background: #6f42c1;">üìä Executive Summary</div>
            <div class="comparison-content">
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; font-size: 1.4em;">üéØ Data Quality Assessment</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="stat-item" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px;">
                            <div class="label" style="color: #f8f9fa; font-size: 0.9em;">Data Quality Score</div>
                            <div class="value" style="color: white; font-size: 2.2em; font-weight: bold;">${qualityScore}%</div>
                            <div style="font-size: 0.8em; color: #e3f2fd; margin-top: 5px;">Fields in all systems</div>
                        </div>
                        <div class="stat-item" style="background: #e8f5e8; padding: 20px;">
                            <div class="label" style="font-size: 0.9em;">Complete Field Coverage</div>
                            <div class="value status-good" style="font-size: 2em; font-weight: bold;">${fieldsInAllFiles}/${totalFields}</div>
                            <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Consistent mapping</div>
                        </div>
                        <div class="stat-item" style="background: #d4edda; padding: 20px;">
                            <div class="label" style="font-size: 0.9em;">Exact Matches</div>
                            <div class="value status-good" style="font-size: 2em; font-weight: bold;">${matchedFields}</div>
                            <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Identical values</div>
                        </div>
                        <div class="stat-item" style="background: #f8d7da; padding: 20px;">
                            <div class="label" style="font-size: 0.9em;">Value Differences</div>
                            <div class="value status-error" style="font-size: 2em; font-weight: bold;">${notMatchedFields}</div>
                            <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Need attention</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #555; margin-bottom: 12px; font-size: 1.1em;">üí° Key Insights & Recommendations</h4>
                    <div style="background: #e8f4fd; padding: 18px; border-radius: 10px; border-left: 4px solid #007acc;">
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 0.95em;">
                            <li><strong>Field Coverage:</strong> ${fieldsInAllFiles} fields (${qualityScore}%) are consistently mapped across all databases</li>
                            <li><strong>Data Consistency:</strong> ${matchedFields} fields have identical values across all databases</li>
                            <li><strong>Data Quality:</strong> ${qualityScore >= 80 ? 'Excellent' : qualityScore >= 60 ? 'Good' : qualityScore >= 40 ? 'Fair' : 'Poor'} overall data consistency score</li>
                            <li><strong>Action Items:</strong> ${notMatchedFields > 0 ? `Review ${notMatchedFields} fields with differing values` : 'All field values are consistent'}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="comparison-section" style="border: 2px solid #007acc;">
            <div class="comparison-header" style="background: #007acc;">üìã Field Presence Analysis</div>
            <div class="comparison-content">
                <div style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div class="stat-item" style="background: #d4edda;">
                            <div class="label">Total Fields</div>
                            <div class="value">${totalFields}</div>
                        </div>
                        <div class="stat-item" style="background: #d1ecf1;">
                            <div class="label">In All Systems</div>
                            <div class="value status-good">${fieldsInAllFiles}</div>
                        </div>
                        <div class="stat-item" style="background: #d4edda;">
                            <div class="label">Matched Values</div>
                            <div class="value status-good">${matchedFields}</div>
                        </div>
                        <div class="stat-item" style="background: #f8d7da;">
                            <div class="label">Different Values</div>
                            <div class="value status-error">${notMatchedFields}</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 15px; padding: 12px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #007acc;">
                    <h5 style="margin: 0 0 8px 0; color: #007acc;">Complete Field Presence & Value Analysis (${totalFields} fields)</h5>
                    <div style="font-size: 0.9em; line-height: 1.6;">
                        üîπ <strong>${fieldsInAllFiles} fields</strong> present in all ${totalFiles} systems (${qualityScore}%)<br>
                        üî∏ <strong>${matchedFields} fields</strong> have identical values across all systems<br>
                        üî¥ <strong>${notMatchedFields} fields</strong> have different values that need review
                    </div>
                </div>
                
                <table class="differences-table">
                    <thead>
                        <tr>
                            <th style="width: 12%;">Field Name</th>
                            ${Object.keys(results.files).map(fileId => `<th style="width: 18%;">${results.files[fileId]}</th>`).join('')}
                            <th style="width: 8%;">Coverage</th>
                            <th style="width: 10%;">Match Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.fieldComparison.map(field => {
                            const presentCount = Object.values(field.presence).filter(p => p === 'Yes').length;
                            const totalFiles = Object.keys(field.presence).length;
                            const coverageClass = presentCount === totalFiles ? 'status-good' : 
                                                 presentCount >= Math.ceil(totalFiles / 2) ? 'status-warning' : 'status-error';
                            
                            const matchStatusClass = field.matchStatus === 'Matched' ? 'matched' : 
                                                   field.matchStatus === 'Not Matched' ? 'not-matched' : 'single-value';
                            
                            return `
                                <tr>
                                    <td><strong>${field.field}</strong></td>
                                    ${Object.keys(results.files).map(fileId => {
                                        const isPresent = field.presence[fileId] === 'Yes';
                                        const value = field.values[fileId];
                                        const displayValue = value !== null && value !== undefined ? value.toString() : '';
                                        
                                        return `
                                            <td class="value-cell">
                                                <div class="presence-indicator ${isPresent ? 'present' : 'missing'}">
                                                    ${isPresent ? '‚úÖ Yes' : '‚ùå No'}
                                                </div>
                                                ${isPresent ? `<div class="value-preview"><code>${displayValue}</code></div>` : ''}
                                            </td>
                                        `;
                                    }).join('')}
                                    <td class="${coverageClass}"><strong>${presentCount}/${totalFiles}</strong></td>
                                    <td><span class="match-status ${matchStatusClass}">${field.matchStatus}</span></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="comparison-section" style="border: 2px solid #28a745;">
            <div class="comparison-header" style="background: #28a745;">üìà Summary Statistics</div>
            <div class="comparison-content">
                <table style="width: 100%; border-collapse: collapse;">
                    <tbody>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 15px; border: 1px solid #dee2e6;"><strong>Total Files Analyzed</strong></td>
                            <td style="padding: 15px; border: 1px solid #dee2e6;">${results.summary.totalFiles}</td>
                        </tr>
                        <tr>
                            <td style="padding: 15px; border: 1px solid #dee2e6;"><strong>Total Unique Fields</strong></td>
                            <td style="padding: 15px; border: 1px solid #dee2e6;">${results.summary.totalFields}</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 15px; border: 1px solid #dee2e6;"><strong>Fields Present in All Files</strong></td>
                            <td style="padding: 15px; border: 1px solid #dee2e6; color: #28a745; font-weight: bold;">${fieldsInAllFiles}</td>
                        </tr>
                        <tr>
                            <td style="padding: 15px; border: 1px solid #dee2e6;"><strong>Fields with Matched Values</strong></td>
                            <td style="padding: 15px; border: 1px solid #dee2e6; color: #28a745; font-weight: bold;">${matchedFields}</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 15px; border: 1px solid #dee2e6;"><strong>Fields with Different Values</strong></td>
                            <td style="padding: 15px; border: 1px solid #dee2e6; color: #dc3545; font-weight: bold;">${notMatchedFields}</td>
                        </tr>
                        <tr>
                            <td style="padding: 15px; border: 1px solid #dee2e6;"><strong>Data Quality Score</strong></td>
                            <td style="padding: 15px; border: 1px solid #dee2e6; color: #007acc; font-weight: bold;">${qualityScore}%</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 15px; border: 1px solid #dee2e6;"><strong>Total Records Analyzed</strong></td>
                            <td style="padding: 15px; border: 1px solid #dee2e6;">${Object.values(results.summary.recordCounts).reduce((a, b) => a + b, 0).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding: 15px; border: 1px solid #dee2e6;"><strong>Report Generated</strong></td>
                            <td style="padding: 15px; border: 1px solid #dee2e6;">${timestamp}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `enhanced-database-comparison-${new Date().toISOString().split('T')[0]}.html`;
            link.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>